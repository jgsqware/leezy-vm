# Lima configuration for Leezy VM
# Lightweight VM with SSH, Tailscale, and TinyProxy

# VM Image - Ubuntu for better compatibility  
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release-20231211.1/ubuntu-22.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release-20231211.1/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# VM Resources
cpus: 1
memory: "512MiB"
disk: "4GiB"

# Network configuration
networks:
  - lima: shared
    # macAddress: "52:55:55:12:34:56" # Optionally set a static MAC

# Port forwarding (SSH port 22 is handled automatically by Lima)
portForwards:
  - guestPort: 8888
    hostPort: 8888 # TinyProxy

# SSH configuration
ssh:
  localPort: 0 # Random local port for SSH
  loadDotSSHPubKeys: true

# Mounts
mounts:
  - location: "~"
    writable: false
  - location: "./config"
    mountPoint: "/tmp/leezy-config"
    writable: false

# Environment variables from .env file
env:
  TAILSCALE_AUTH_KEY: "{{.Env.TAILSCALE_AUTH_KEY}}"
  TAILSCALE_HOSTNAME: "{{.Env.TAILSCALE_HOSTNAME}}"
  TAILSCALE_ACCEPT_ROUTES: "{{.Env.TAILSCALE_ACCEPT_ROUTES}}"

# Provisioning script
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -e
      
      echo "Starting Leezy VM provisioning on Lima (Ubuntu)..."
      
      # Update package repository
      apt-get update
      
      # Install essential packages
      apt-get install -y \
          curl \
          wget \
          sudo \
          iptables \
          ca-certificates \
          gnupg \
          lsb-release
      
      # SSH is already configured in Ubuntu cloud images
      
      # Install Tailscale
      echo "Installing Tailscale..."
      curl -fsSL https://tailscale.com/install.sh | sh
      
      # Enable and start Tailscale service
      systemctl enable tailscaled
      systemctl start tailscaled
      
      # Install TinyProxy
      echo "Installing TinyProxy..."
      apt-get install -y tinyproxy
      
      # Copy TinyProxy configuration from mounted config
      if [ -f /tmp/leezy-config/tinyproxy.conf ]; then
          echo "Using custom TinyProxy configuration..."
          cp /tmp/leezy-config/tinyproxy.conf /etc/tinyproxy/tinyproxy.conf
      else
          echo "Warning: Config file not found at /tmp/leezy-config/tinyproxy.conf"
          echo "Using default TinyProxy configuration..."
      fi
      
      # Enable and start TinyProxy service
      systemctl enable tinyproxy
      systemctl restart tinyproxy
      
      echo "Base provisioning complete!"

  - mode: user
    script: |
      #!/bin/bash
      
      # Auto-authenticate Tailscale if auth key is provided
      if [ ! -z "$TAILSCALE_AUTH_KEY" ]; then
          echo "Authenticating Tailscale with provided auth key..."
          sleep 2
          
          # Build tailscale up command with options
          TS_CMD="sudo tailscale up --authkey=\"$TAILSCALE_AUTH_KEY\""
          
          # Add hostname if provided
          if [ ! -z "$TAILSCALE_HOSTNAME" ]; then
              TS_CMD="$TS_CMD --hostname=\"${TAILSCALE_HOSTNAME:-leezy-vm}\""
          fi
          
          # Add accept-routes flag if enabled
          if [ "${TAILSCALE_ACCEPT_ROUTES:-true}" = "true" ]; then
              TS_CMD="$TS_CMD --accept-routes"
          fi
          
          # Execute the command
          eval $TS_CMD || {
              echo "Warning: Tailscale authentication failed. You may need to authenticate manually."
          }
          echo "Tailscale status:"
          sudo tailscale status || true
      else
          echo ""
          echo "================================"
          echo "Tailscale not configured"
          echo "================================"
          echo "To authenticate Tailscale, run:"
          echo "  limactl shell leezy-vm"
          echo "  sudo tailscale up"
          echo "================================"
      fi
      
      echo ""
      echo "================================"
      echo "Leezy VM is ready!"
      echo "================================"
      echo "Services:"
      echo "  - SSH: limactl shell leezy-vm"
      echo "  - TinyProxy: http://localhost:8888"
      echo "  - Tailscale: configured"
      echo "================================"

# Message shown after VM is started
message: |
  Leezy VM is running!
  
  To access the VM:
    limactl shell leezy-vm
  
  TinyProxy is available at:
    http://localhost:8888
  
  To check Tailscale status:
    limactl shell leezy-vm sudo tailscale status